# build.zip 압축 방식 및 생성 패턴 개선 결과 보고서

## 📌 문제 상황 요약

GitHub Actions 워크플로우에서 Azure App Service 배포 시 다음과 같은 문제가 발생했습니다:

1. `build.zip` 파일이 명시적으로 생성되지 않거나 구조적으로 잘못 생성됨
2. 쿠두와 같은 배포 도구는 ZIP 파일 내 루트 경로에 파일이 있어야 하는데, `build/` 내부에 중첩되는 문제 발생
3. 불필요한 `deploy.zip` 파일이 간혹 생성되어 혼란 야기

## 🛠️ 개선 내용

### 1. 명시적 ZIP 파일 생성 구문 개선

**변경 전**:
```yaml
echo "Creating build.zip for direct deployment verification..."
cd build && zip -r ../build.zip * && cd ..
```

**변경 후**:
```yaml
# deploy.zip이 있으면 제거 (불필요한 파일 정리)
if [ -f "deploy.zip" ]; then
  echo "🔄 Removing unnecessary deploy.zip file"
  rm -f deploy.zip
fi

# build.zip 명시적 생성 - build/ 폴더 내용만 루트에 압축
echo "🔄 Creating build.zip with the correct structure..."
cd build && zip -r ../build.zip * && cd ..

# zip 파일 존재 검증
if [ ! -f "build.zip" ]; then
  echo "::error::build.zip file was not created. Deployment will fail."
  exit 1
fi

# zip 파일 크기 검증
ZIP_SIZE_BYTES=$(du -b build.zip | cut -f1)
if [ "$ZIP_SIZE_BYTES" -lt 1000 ]; then
  echo "::error::build.zip is too small (${ZIP_SIZE_BYTES} bytes). The compression likely failed."
  exit 1
fi
```

### 2. 향상된 ZIP 구조 검증 절차 추가

**변경 전**: 기존에는 간단한 파일 존재 여부만 확인하고 경고 표시

**변경 후**: 엄격한 구조 검증으로 배포 전 실패 감지
```yaml
- name: Strict ZIP structure verification
  run: |
    echo "Running strict ZIP structure verification..."
    
    # 중요 파일들이 루트에 직접 있는지 확인
    echo "Checking zip file structure..."
    if unzip -l build.zip | grep -q "build/"; then
      echo "::error::ZIP file contains nested 'build/' directory. The structure is incorrect."
      echo "Current ZIP structure (showing nested paths):"
      unzip -l build.zip | grep "build/"
      exit 1
    fi
    
    # 핵심 파일들 루트 레벨 검증
    echo "Checking for essential files at the root level..."
    MISSING_FILES=0
    
    if ! unzip -l build.zip | grep -q "index.html"; then
      echo "::error::index.html not found at zip root"
      MISSING_FILES=$((MISSING_FILES+1))
    else
      echo "✅ index.html found at zip root"
    fi
    
    # 추가 파일 검증...
```

### 3. 주요 개선 사항

1. **명확한 압축 규칙 적용**:
   - `build/` 폴더 내 파일들만 선택하여 루트에 압축
   - `cd build && zip -r ../build.zip * && cd ..` 명령으로 올바른 디렉토리 구조 보장

2. **fail-fast 검증**:
   - ZIP 파일 자체 생성 여부 검증
   - ZIP 파일 최소 크기 검증
   - 필수 파일 존재 검증
   - 중첩된 `build/` 경로 없는지 검증

3. **불필요 파일 정리**:
   - `deploy.zip` 같은 불필요 파일 자동 제거
   - 혼란을 방지하기 위한 명확한 로깅 메시지 추가

## ✅ 적용 결과

### 1. ZIP 파일 생성 결과

GitHub Actions 로그에서 확인된 결과:

```
🔄 Creating build.zip with the correct structure...
  adding: asset-manifest.json (deflated 71%)
  adding: favicon.ico (deflated 56%)
  adding: health (stored 0%)
  adding: health.html (deflated 20%)
  adding: index.html (deflated 73%)
  adding: logo192.png (deflated 0%)
  ...
✅ Build content verified and archived for deployment.
build.zip details:
680K    build.zip
```

### 2. ZIP 구조 검증 결과

```
Running strict ZIP structure verification...
Checking zip file structure...
Checking for essential files at the root level...
✅ index.html found at zip root
✅ static/ directory found at zip root
✅ favicon.ico found at zip root
✅ ZIP structure verification passed! The build.zip file is ready for deployment.
```

### 3. 배포 결과

```
HTTP response code: 202
✅ Deployment successful with HTTP status code: 202

Files in /site/wwwroot:
index.html
static
favicon.ico
manifest.json
...
```

## 🔄 전체 워크플로우 개선 효과

이번 개선으로 다음과 같은 효과를 얻었습니다:

1. **올바른 구조의 ZIP 파일 보장**:
   - Azure App Service 웹 루트(`/site/wwwroot`)에 파일이 올바른 구조로 배포됨
   - 중첩된 `build/` 폴더 문제 방지

2. **명확한 배포 실패 감지**:
   - 잘못된 ZIP 구조는 배포 시도 전에 워크플로우를 중단시킴
   - 실패 원인을 명확히 표시하여 디버깅 용이성 향상

3. **일관된 배포 패턴 확립**:
   - 항상 동일한 방식으로 ZIP 파일 생성
   - 여러 가지 압축 파일 대신 단일 `build.zip` 사용으로 혼란 방지

## 📊 결론 및 권장사항

이번 수정을 통해 Azure 배포용 ZIP 파일의 생성과 구조가 안정화되었습니다. 향후 다음 사항을 권장합니다:

1. **자동화된 ZIP 구조 테스트**:
   - 새 기능 개발 시 항상 ZIP 구조 검증 유지
   - 빌드 출력 구조 변경 시 검증 로직도 함께 업데이트

2. **배포 패턴 표준화**:
   - 모든 Azure 배포 프로젝트에 동일한 ZIP 생성 패턴 적용
   - 개발자 간 일관된 배포 가이드라인 공유

3. **모니터링 강화**:
   - 배포 과정에서 ZIP 파일 크기와 내용물 변화 추적
   - 특이 패턴 발견 시 자동 알림 설정 고려 