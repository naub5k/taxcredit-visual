# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
name: Build and deploy Node.js app to Azure Web App - taxcredit-visual

on:
  push:
    branches:
      - master
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'

      - name: Install dependencies and build
        run: |
          npm install
          npm run build
          
          # Check if build directory exists and has content
          if [ ! -d "build" ] || [ -z "$(ls -A build)" ]; then
            echo "::error::Build directory is empty or does not exist. Build may have failed."
            exit 1
          fi
          echo "Build completed successfully. Content verified in build directory."

      - name: Run tests (optional)
        run: echo "No tests configured. Skipping..."

      - name: Create web.config file
        run: |
          echo '<?xml version="1.0" encoding="utf-8"?>
          <configuration>
            <system.webServer>
              <rewrite>
                <rules>
                  <rule name="React Routes" stopProcessing="true">
                    <match url=".*" />
                    <conditions logicalGrouping="MatchAll">
                      <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
                      <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
                      <add input="{REQUEST_URI}" pattern="^/(api)" negate="true" />
                    </conditions>
                    <action type="Rewrite" url="/" />
                  </rule>
                </rules>
              </rewrite>
              <staticContent>
                <mimeMap fileExtension=".json" mimeType="application/json" />
                <mimeMap fileExtension=".woff" mimeType="application/font-woff" />
                <mimeMap fileExtension=".woff2" mimeType="application/font-woff2" />
              </staticContent>
            </system.webServer>
          </configuration>' > build/web.config

      - name: Create health endpoint for Azure App Service
        run: |
          echo "OK" > build/health
          # health.html 파일은 public 폴더에서 자동으로 build 폴더로 복사됩니다.

      - name: Create staticwebapp.config.json for SPA routing
        run: |
          echo '{
            "navigationFallback": {
              "rewrite": "/index.html",
              "exclude": ["/static/*", "/images/*", "/*.{png,jpg,gif,ico,css,js}"]
            },
            "routes": [
              {
                "route": "/health",
                "serve": "/health.html"
              },
              {
                "route": "/*",
                "serve": "/index.html",
                "statusCode": 200
              }
            ]
          }' > build/staticwebapp.config.json

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: 'bbd4460e-5bbf-4ab6-ae25-ce532a24f6ab'
          allow-no-subscriptions: true

      - name: Verify build content before deployment
        run: |
          echo "Checking build directory content before deployment..."
          find build -type f | sort
          echo "Total files in build directory: $(find build -type f | wc -l)"
          echo "Content of index.html:"
          cat build/index.html | head -20
          echo "Creating build.zip for direct deployment verification..."
          cd build && zip -r ../build.zip * && cd ..
          echo "✅ Build content verified and archived for deployment."
          echo "Verifying ZIP file contents..."
          unzip -l build.zip | head -10

      - name: Additional ZIP file structure verification
        if: always()
        run: |
          echo "Detailed ZIP file structure verification..."
          unzip -l build.zip
          echo "Checking for key files in ZIP root..."
          if unzip -l build.zip | grep -q "index.html"; then
            echo "✅ index.html found at ZIP root"
          else
            echo "⚠️ index.html not found at ZIP root"
          fi
          
          if unzip -l build.zip | grep -q "static/"; then
            echo "✅ static/ directory found at ZIP root"
          else
            echo "⚠️ static/ directory not found at ZIP root"
          fi
          
          if unzip -l build.zip | grep -q "favicon.ico"; then
            echo "✅ favicon.ico found at ZIP root"
          else
            echo "⚠️ favicon.ico not found at ZIP root"
          fi

      - name: Manual deployment using Kudu API
        run: |
          echo "Extracting credentials from publish profile..."
          # PublishProfile에서 정보 추출
          KUDU_URL=$(echo "${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE }}" | grep -o 'publishUrl="[^"]*"' | cut -d'"' -f2 | sed 's|:443||')
          USERNAME=$(echo "${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE }}" | grep -o 'userName="[^"]*"' | cut -d'"' -f2)
          PASSWORD=$(echo "${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE }}" | grep -o 'userPWD="[^"]*"' | cut -d'"' -f2)
          
          echo "Kudu URL: https://$KUDU_URL (Username will be masked)"
          
          echo "Preparing for ZIP deployment via Kudu API..."
          echo "ZIP file size: $(du -h build.zip | cut -f1)"
          
          echo "Running ZIP deployment via Kudu API..."
          HTTP_STATUS=$(curl -s -w "%{http_code}" -o kudu_response.txt -X POST \
            "https://$KUDU_URL/api/zipdeploy" \
            -u "$USERNAME:$PASSWORD" \
            -H "Content-Type: application/zip" \
            --data-binary @build.zip)
          
          echo "Kudu API response status code: $HTTP_STATUS"
          
          if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 300 ]; then
            echo "✅ Deployment successful with status code: $HTTP_STATUS"
          else
            echo "⚠️ Deployment may have failed. Status code: $HTTP_STATUS"
            echo "Response from Kudu API:"
            cat kudu_response.txt
            # 실패해도 계속 진행
            echo "::warning::Deployment via Kudu API returned unexpected status code: $HTTP_STATUS"
          fi
          
          echo "Waiting for deployment to complete and files to be accessible..."
          sleep 60
          
          echo "Verifying deployment..."
          LIST_STATUS=$(curl -s -w "%{http_code}" -o wwwroot_listing.txt \
            "https://$KUDU_URL/api/vfs/site/wwwroot/" \
            -u "$USERNAME:$PASSWORD" \
            -H "Accept: application/json")
          
          echo "Kudu API listing status code: $LIST_STATUS"
          
          if [ "$LIST_STATUS" -ge 200 ] && [ "$LIST_STATUS" -lt 300 ]; then
            echo "✅ Successfully retrieved wwwroot directory listing"
            echo "Files in /site/wwwroot:"
            cat wwwroot_listing.txt | grep -o '"name":"[^"]*"' | cut -d'"' -f4
          else
            echo "⚠️ Failed to retrieve wwwroot directory listing. Status code: $LIST_STATUS"
            echo "Response:"
            cat wwwroot_listing.txt
            echo "::warning::Failed to verify deployment content in wwwroot"
          fi

      - name: Verify deployment
        run: |
          echo "Deployment completed, waiting for 30 seconds for the app to be available..."
          sleep 30
          
          # Check if the app is accessible
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://taxcredit-visual.azurewebsites.net/health)
          echo "Health endpoint status: $HTTP_STATUS"
          
          # Additional checks for static resources
          INDEX_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://taxcredit-visual.azurewebsites.net/index.html)
          echo "Index.html status: $INDEX_STATUS"
          
          STATIC_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://taxcredit-visual.azurewebsites.net/static)
          echo "Static directory status: $STATIC_STATUS"
          
          if [ "$HTTP_STATUS" == "200" ] && [ "$INDEX_STATUS" == "200" ]; then
            echo "✅ Deployment successful! App is accessible."
          else
            echo "⚠️ App might not be fully accessible yet. Please check manually."
            echo "::warning::App deployment validation didn't fully pass. Manual verification recommended."
          fi

      - name: Deployment summary
        run: |
          echo "## 📊 Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "* **Application:** taxcredit-visual" >> $GITHUB_STEP_SUMMARY
          echo "* **Deployment time:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "* **URL:** https://taxcredit-visual.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
